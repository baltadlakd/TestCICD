name: Crear rama dedicada a cliente

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Nombre del archivo de cliente en .clients/'
        required: true

jobs:
  create_dedicated_client_branch:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout completo del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar existencia del archivo cliente en .clients/
        run: |
          if [ ! -f ".clients/${{ github.event.inputs.branch_name }}" ]; then
            echo "Error: El archivo .clients/${{ github.event.inputs.branch_name }} no existe. Abortando."
            exit 1
          fi

      - name: Determinar nombre de rama
        id: determine_branch_name
        run: |
          if git ls-remote --exit-code --heads origin "${{ github.event.inputs.branch_name }}"; then
            echo "La rama existe, se usará nombre con sufijo."
            commit_ref=$(git rev-parse --short HEAD)
            NEW_BRANCH="${{ github.event.inputs.branch_name }}-${commit_ref}"
          else
            NEW_BRANCH="${{ github.event.inputs.branch_name }}"
          fi
          echo "NEW_BRANCH=${NEW_BRANCH}"
          echo "new_branch=${NEW_BRANCH}" >> $GITHUB_OUTPUT

      - name: Set up git configuration
        run: |
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          git config --global user.name "${{ github.actor }}"

      - name: Crear rama de cliente y commit inicial
        run: |
          cp ".clients/${{ github.event.inputs.branch_name }}" "/tmp/${{ github.event.inputs.branch_name }}"
          git switch --orphan "${{ steps.determine_branch_name.outputs.new_branch }}"
          while IFS= read -r file || [ -n "$file" ]; do
            git checkout main -- "$file"
          done < "/tmp/${{ github.event.inputs.branch_name }}"
          git commit -m "Initial commit for: ${{ steps.determine_branch_name.outputs.new_branch }}"

      - name: Push files to the new branch
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ steps.determine_branch_name.outputs.new_branch }}

      - name: Crear pull request hacia la rama principal del cliente
        if: ${{ steps.determine_branch_name.outputs.new_branch != github.event.inputs.branch_name }}
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: ${{ github.event.inputs.branch_name }}
          branch: ${{ steps.determine_branch_name.outputs.new_branch }}
          title: "PR: ${{ steps.determine_branch_name.outputs.new_branch }} -> ${{ github.event.inputs.branch_name }}"
          body: "Pull request automático desde la rama ${{ steps.determine_branch_name.outputs.new_branch }}"
