name: Crear rama dedicada a cliente

on:
  workflow_dispatch:
    inputs:
      branch_name:
        description: 'Nombre del archivo de cliente en .clients/'
        required: true

jobs:
  create_dedicated_client_branch:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout completo del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar existencia del archivo cliente y que no exista la rama
        run: |
          if [ ! -f ".clients/${{ github.event.inputs.branch_name }}" ]; then
            echo "Error: El archivo .clients/${{ github.event.inputs.branch_name }} no existe. Abortando."
            exit 1
          fi
          # Verificar que la rama no existe 
          if git ls-remote --exit-code --heads origin "${{ github.event.inputs.branch_name }}"; then
            echo "Error: La rama ${{ github.event.inputs.branch_name }} ya existe. Abortando."
            exit 1
          fi

      - name: Crear rama huérfana y commit inicial
        run: |
          # Extraer la lista de archivos desde .clients/${{ github.event.inputs.branch_name }}
          files=$(cat ".clients/${{ github.event.inputs.branch_name }}" | xargs)
          # Crear la rama huérfana
          git checkout --orphan "${{ github.event.inputs.branch_name }}"
          git reset --hard
          # Hacer checkout de los archivos listados desde la rama main
          git checkout main -- $files
          # Crear un README.md y agregarlo junto con los archivos extraídos
          echo "Creando rama huérfana: ${{ github.event.inputs.branch_name }}" > README.md
          git add $files README.md
          git commit -m "Commit inicial en la rama huérfana: ${{ github.event.inputs.branch_name }}"
          git push origin "${{ github.event.inputs.branch_name }}"
